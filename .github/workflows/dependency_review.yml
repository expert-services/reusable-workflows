name: Dependency Review

on: 
  workflow_call:
    inputs:
      directory:
        description: The directory containing the pom.xml file
        required: true
        type: string
      java-version:
        description: The Java version that should be used with setup-java
        required: true
        type: string
      java-distribution:
        description: The Java distribution that should be used with setup-java
        required: true
        type: string
jobs:
  dependency_analysis:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: write
      statuses: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Java
        if: ${{ inputs.java-version != '' && inputs.java-distribution != '' }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }} 
          distribution: ${{ inputs.java-distribution}} 
      - name: Submit dependency snapshot for Java (Maven)
        uses: david-wiggs/maven-dependency-submission-action@unique-job-matrix
        with:
          directory: ${{ inputs.directory }}
          correlator: ${{ github.job }}-${{ inputs.directory }}
      - name: Dependency validation
        if: ${{ github.event_name == 'pull_request' }}
        id: dependency_validation
        uses: actions/dependency-review-action@v2
        continue-on-error: true
        with:
          fail-on-scopes: "runtime, development, unknown"
      - name: Publish status to PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: octodemo/github-status-action@v2
        with:
          authToken: ${{ secrets.GITHUB_TOKEN }}
          state: ${{ steps.dependency_validation.outcome }}
          context: Dependency scanning results / Dependency Review
          description: "${{ steps.dependency_validation.outcome }} (see details for more information)"
          sha: ${{ github.event.pull_request.head.sha }}
          target_url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
